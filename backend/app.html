<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Query</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .collage-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
        }

        .collage-image {
            position: absolute;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            animation: float 20s infinite ease-in-out;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0) rotate(0deg);
            }

            25% {
                transform: translateY(-20px) rotate(2deg);
            }

            50% {
                transform: translateY(0) rotate(-2deg);
            }

            75% {
                transform: translateY(-15px) rotate(1deg);
            }
        }

        .content-overlay {
            position: relative;
            z-index: 1;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Animated Collage Background -->
    <div id="collageContainer" class="collage-container"></div>

    <!-- Main Content -->
    <div class="content-overlay container mx-auto px-4 py-8">
        <!-- Header with Logo and Title -->
        <div class="flex flex-col items-center mb-12 mt-8">
            <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mb-4 shadow-lg">
                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-gray-800">NASA Research Query Tool</h1>
        </div>

        <!-- Search Bar Section -->
        <div class="max-w-4xl mx-auto">
            <div class="glass-effect rounded-lg shadow-md p-6 mb-6">
                <div class="flex gap-3">
                    <input type="text" id="searchInput" placeholder="Enter your research query..."
                        class="flex-1 px-4 py-3 text-lg border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                    <select id="audienceSelect"
                        class="px-4 py-3 text-lg border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white min-w-[150px]">
                        <option value="scientist">Scientist</option>
                        <option value="manager">Manager</option>
                    </select>
                    <button id="searchBtn"
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium shadow-sm">
                        Search
                    </button>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loading" class="hidden text-center py-8">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                <p class="mt-4 text-gray-600 font-medium">Processing your query...</p>
            </div>

            <!-- Results Section -->
            <div id="results" class="hidden glass-effect rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Results</h2>
                <div id="resultContent" class="text-gray-700 leading-relaxed whitespace-pre-wrap"></div>
            </div>

            <!-- Error Section -->
            <div id="error" class="hidden glass-effect border border-red-200 rounded-lg p-6">
                <h2 class="text-xl font-semibold text-red-800 mb-2">Error</h2>
                <p id="errorContent" class="text-red-700"></p>
            </div>
        </div>
    </div>

    <script>
        const searchInput = document.getElementById('searchInput');
        const audienceSelect = document.getElementById('audienceSelect');
        const searchBtn = document.getElementById('searchBtn');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const resultContent = document.getElementById('resultContent');
        const error = document.getElementById('error');
        const errorContent = document.getElementById('errorContent');
        const collageContainer = document.getElementById('collageContainer');

        const PIXABAY_API_KEY = '52616469-8b9ae96131f1e8bce7967bd5d';
        let collageImages = [];

        async function fetchCollageImages(query) {
            try {
                const response = await fetch(
                    `https://pixabay.com/api/?key=${PIXABAY_API_KEY}&q=${encodeURIComponent(query)}&image_type=photo&per_page=20&pretty=true`
                );

                if (!response.ok) throw new Error('Failed to fetch images');

                const data = await response.json();
                return data.hits || [];
            } catch (err) {
                console.error('Collage fetch error:', err);
                return [];
            }
        }

        function createCollageImage(imageData, index) {
            const img = document.createElement('img');
            img.src = imageData.webformatURL;
            img.alt = imageData.tags;
            img.className = 'collage-image';

            // Random size between 150-250px
            const size = 150 + Math.random() * 100;
            img.style.width = `${size}px`;
            img.style.height = `${size}px`;
            img.style.objectFit = 'cover';

            // Random position
            img.style.left = `${Math.random() * (window.innerWidth - size)}px`;
            img.style.top = `${Math.random() * (window.innerHeight - size)}px`;

            // Random animation delay and duration
            img.style.animationDelay = `${Math.random() * 5}s`;
            img.style.animationDuration = `${15 + Math.random() * 10}s`;

            // Fade in
            img.style.opacity = '0';
            setTimeout(() => {
                img.style.opacity = '0.3';
            }, index * 100);

            return img;
        }

        function updateCollage(images) {
            // Clear existing collage
            collageContainer.innerHTML = '';
            collageImages = [];

            if (images.length === 0) return;

            // Create collage with up to 15 images
            const imagesToShow = images.slice(0, 15);
            imagesToShow.forEach((imageData, index) => {
                const img = createCollageImage(imageData, index);
                collageContainer.appendChild(img);
                collageImages.push(img);
            });

            // Animate positions every 10 seconds
            setInterval(() => {
                collageImages.forEach(img => {
                    const size = parseInt(img.style.width);
                    img.style.left = `${Math.random() * (window.innerWidth - size)}px`;
                    img.style.top = `${Math.random() * (window.innerHeight - size)}px`;
                });
            }, 10000);
        }

        async function performSearch() {
            const query = searchInput.value.trim();
            const audience = audienceSelect.value;

            if (!query) {
                showError('Please enter a search query');
                return;
            }

            // Hide previous results/errors
            results.classList.add('hidden');
            error.classList.add('hidden');
            loading.classList.remove('hidden');

            // Fetch collage images in parallel
            const collagePromise = fetchCollageImages(query);

            try {
                const response = await fetch('http://localhost:8000/api/summarize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        audience: audience,
                        top_k: 5
                    })
                });

                loading.classList.add('hidden');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                displayResults(data);

                // Update collage with fetched images
                const images = await collagePromise;
                updateCollage(images);
            } catch (err) {
                loading.classList.add('hidden');
                showError(`Failed to fetch results: ${err.message}`);

                // Still update collage even if main query fails
                const images = await collagePromise;
                updateCollage(images);
            }
        }

        function displayResults(data) {
            // Parse JSON if it's a string
            const parsed = typeof data === 'string' ? JSON.parse(data) : data;

            // Build formatted HTML
            let html = `
                <div class="border rounded bg-gray-50 shadow-md m-0 p-0">
                <h2 class="text-xl font-bold m-0 p-0">Query</h2>
                <p class="m-0 p-0"> ${parsed.query}</p>

                <h2 class="text-xl font-bold m-0 p-0">Audience</h2>
                <p class="m-0 p-0"> ${parsed.audience}</p>

                <h2 class="text-xl font-bold m-0 p-0">Summary</h2>
                <div class="prose m-0 p-0 whitespace-pre-line">
                    ${parsed.summary
                        // Convert Markdown-style **bold** into <strong>
                        .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
                        // Convert * list items into <li>
                        .replace(/\n\*   /g, "\n<li>")
                        .replace(/\n\* /g, "\n<li>")
                        .replace(/<\/li>\s*<li>/g, "</li><li>") // keep list structure clean
                    }

                    </div>
                </div>
    `;

            // Inject into page
            resultContent.innerHTML = html;
            results.classList.remove('hidden');
        }

        function showError(message) {
            errorContent.textContent = message;
            error.classList.remove('hidden');
        }

        // Event listeners
        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // Initialize with default collage
        (async () => {
            const defaultImages = await fetchCollageImages('science research');
            updateCollage(defaultImages);
        })();
    </script>
</body>

</html>